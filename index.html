<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stercord - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bgA:#0b1020; --bgB:#1a0430;
    --card-bg:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    --accent1:#9d4edd; --accent2:#6a0dad;
    --muted:rgba(255,255,255,0.7);
    --glass:rgba(255,255,255,0.03);
    --success:linear-gradient(135deg,#34d399,#10b981);
    --danger:linear-gradient(135deg,#ef4444,#dc2626);
    --warn:linear-gradient(135deg,#f59e0b,#fbbf24);
    --radius:16px;
    
    /* Chat variables */
    --bg-body: #09090b;
    --bg-sidebar: #121214;
    --bg-card: #1c1c1e;
    --bg-input: #27272a;
    --accent: #007aff;
    --accent-mine: #34c759;
    --text-main: #ffffff;
    --text-muted: #a1a1aa;
    --border: #27272a;
    --radius-chat: 14px;
  }

  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif}
  html,body{height:100%}
  body{
    min-height:100vh;
    display:flex;align-items:center;justify-content:center;padding:24px;
    background:linear-gradient(135deg,var(--bgB),var(--bgA));
    -webkit-font-smoothing:antialiased;color:#fff;
  }

  .container{width:100%;max-width:800px}
  .card{
    display:grid;grid-template-columns:380px 1fr;gap:18px;
    background:var(--card-bg);border-radius:var(--radius);padding:22px;
    box-shadow:0 18px 50px rgba(0,0,0,0.6);border:1px solid rgba(157,78,221,0.07);
    overflow:hidden;
  }
  @media (max-width:820px){
    .card{grid-template-columns:1fr;padding:18px}
  }

  /* Left brand panel */
  .brand{
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:22px;background:
    radial-gradient(400px 200px at 10% 10%, rgba(157,78,221,0.06), transparent 8%);
    border-radius:12px; gap:10px; text-align:center;
  }
  .brand .logo{
    width:86px;height:86px;border-radius:20px;display:grid;place-items:center;
    background:linear-gradient(135deg,var(--accent2),var(--accent1));
    box-shadow:0 10px 30px rgba(157,78,221,0.24);font-size:36px;
  }
  .brand h1{font-size:20px;margin-top:6px;letter-spacing:-0.3px}
  .brand p{color:var(--muted);font-size:13px;max-width:260px}

  /* Right content (forms) */
  .forms{padding:6px 6px 6px 10px}
  h2{font-size:18px;margin-bottom:8px}
  .subtitle{color:var(--muted);font-size:13px;margin-bottom:16px}

  form{max-width:100%}
  .field{position:relative;margin-bottom:14px}
  label.sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}

  .input{
    width:100%;padding:12px 44px 12px 46px;border-radius:999px;
    background:var(--glass);color:#fff;border:1px solid rgba(255,255,255,0.06);font-size:15px;
    outline:none;transition:box-shadow .14s ease,border-color .14s ease;
    box-shadow: inset 0 -6px 12px rgba(0,0,0,0.25);
  }
  .input:focus{border-color:rgba(157,78,221,0.9);box-shadow:0 12px 34px rgba(157,78,221,0.06)}

  .left-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:16px;color:rgba(255,255,255,0.64);pointer-events:none}
  .right-group{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px;align-items:center}

  .icon-btn{
    background:transparent;border:0;color:rgba(255,255,255,0.78);font-size:14px;padding:6px;border-radius:10px;cursor:pointer;
    display:inline-grid;place-items:center;line-height:1;
  }
  .icon-btn:focus{outline:2px solid rgba(157,78,221,0.18);outline-offset:2px}

  /* Validation bubble (right-most) */
  .validation{
    width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-size:14px;color:#fff;
    box-shadow:0 10px 26px rgba(0,0,0,0.36);transform:scale(.96);opacity:0;transition:transform .18s ease,opacity .18s ease;
  }
  .validation.show{opacity:1;transform:scale(1)}
  .validation.valid{background:var(--success)}
  .validation.invalid{background:var(--danger)}

  /* Password strength bar */
  .pw-wrap{margin:10px 0 14px}
  .pw-track{height:8px;border-radius:8px;background:rgba(255,255,255,0.04);overflow:hidden;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.3)}
  .pw-bar{height:100%;width:0;transition:width .32s cubic-bezier(.2,.9,.2,1),background .22s linear;border-radius:8px}
  .pw-bar.weak{width:30%;background:var(--danger)}
  .pw-bar.medium{width:66%;background:var(--warn)}
  .pw-bar.strong{width:100%;background:var(--success)}

  .btn{width:100%;padding:12px;border-radius:999px;border:none;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#fff;font-weight:700;cursor:pointer;margin-top:6px;box-shadow:0 10px 26px rgba(0,0,0,0.42);font-size:15px}
  .link{color:var(--accent1);cursor:pointer;font-weight:700;background:transparent;border:0;padding:0}

  .muted{color:var(--muted);font-size:13px;text-align:center;margin-top:10px}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(6px);bottom:26px;background:rgba(0,0,0,0.6);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(2,6,23,0.6);opacity:0;pointer-events:none;transition:opacity .22s,transform .22s}
  .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0)}

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 24px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7);
    border: 1px solid var(--border);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
  }
  
  .modal-close:hover {
    color: var(--text-main);
  }
  
  .avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 20px;
    display: block;
    background: #333;
  }
  
  .modal-field {
    margin-bottom: 16px;
  }
  
  .modal-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-muted);
    font-size: 14px;
  }
  
  .modal-input {
    width: 100%;
    padding: 12px 16px;
    border-radius: var(--radius);
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--text-main);
    font-size: 14px;
  }
  
  .modal-input:focus {
    border-color: var(--accent1);
  }
  
  .modal-textarea {
    min-height: 100px;
    resize: vertical;
  }

  /* Shake */
  @keyframes shakeX{0%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}100%{transform:translateX(0)}}
  .shake{animation:shakeX .5s ease both}

  /* Chat Interface Styles */
  #chat-interface {
    display: none;
    width: 100%;
    height: 100%;
    max-width: 1300px;
    max-height: 850px;
    background: var(--bg-sidebar);
    position: relative;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    overflow: hidden;
  }
  
  @media (min-width: 800px) {
    #chat-interface {
      border-radius: 24px;
      height: 92vh;
      border: 1px solid var(--border);
    }
  }

  .sidebar {
    width: 320px;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  
  .my-profile-mini {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .my-profile-mini:hover {
    background: rgba(255,255,255,0.05);
  }
  
  .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    background: #333;
  }
  
  .contact-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .chat-area {
    flex: 1;
    background: var(--bg-body);
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .chat-header {
    padding: 16px 20px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.5;
    position: relative;
    word-break: break-word;
    animation: message-in 0.3s ease-out;
  }
  
  .msg.mine {
    align-self: flex-end;
    background: var(--accent-mine);
    color: white;
    border-bottom-right-radius: 4px;
  }
  
  .msg.theirs {
    align-self: flex-start;
    background: var(--bg-card);
    color: var(--text-main);
    border-bottom-left-radius: 4px;
  }
  
  .msg img {
    max-width: 100%;
    border-radius: 12px;
    margin-top: 5px;
    display: block;
  }
  
  .msg-meta {
    font-size: 10px;
    opacity: 0.6;
    text-align: right;
    margin-top: 4px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
  }

  .input-zone {
    padding: 16px;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    align-items: flex-end;
    position: relative;
  }
  
  @keyframes message-in {
    from { opacity: 0; transform: translateY(10px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  
  .chat-btn, .chat-btn button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: var(--radius-chat);
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .chat-btn:hover, .chat-btn button:hover {
    background: #0056b3;
  }
  
  .chat-icon-btn {
    padding: 8px;
    background: transparent;
    color: var(--text-muted);
    border-radius: 50%;
  }
  
  .chat-icon-btn:hover {
    background: var(--bg-input);
    color: var(--text-main);
  }
  
  .chat-input, .chat-textarea {
    background: var(--bg-input);
    border: 1px solid transparent;
    color: white;
    padding: 12px 16px;
    border-radius: var(--radius-chat);
    width: 100%;
    font-size: 14px;
    font-family: inherit;
    transition: 0.2s;
  }
  
  .chat-input:focus, .chat-textarea:focus {
    border-color: var(--accent);
    background: #2d2d30;
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      position: absolute;
      height: 100%;
      z-index: 20;
      transition: transform 0.3s;
    }
    
    .sidebar.hidden {
      transform: translateX(-100%);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
      animation: none !important;
    }
  }
</style>
</head>
<body>
  <!-- Authentication Interface -->
  <div class="container" id="auth-container">
    <div class="card" role="region" aria-label="–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è">
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true"><i class="fa-solid fa-rocket"></i></div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä Stercord!</h1>
        <p>–£–¥–æ–±–Ω—ã–π –∏ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä!</p>
      </div>

      <div class="forms" id="forms-area">
        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <form id="register-form" novalidate aria-labelledby="reg-title">
          <h2 id="reg-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
          <p class="subtitle">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –±—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ</p>

          <!-- username -->
          <div class="field">
            <label for="username" class="sr-only">–ù–∏–∫–Ω–µ–π–º</label>
            <i class="fa-solid fa-user left-icon" aria-hidden="true"></i>
            <input id="username" class="input" placeholder="–ù–∏–∫ (3‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="off" />
            <div class="right-group" aria-hidden="true">
              <span id="username-validation" class="validation" aria-hidden="true" title=""></span>
            </div>
          </div>

          <!-- password -->
          <div class="field">
            <label for="password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
            <i class="fa-solid fa-lock left-icon" aria-hidden="true"></i>
            <input id="password" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" />
            <div class="right-group">
              <!-- toggle for password (placed before validation) -->
              <button type="button" id="toggle-password" class="icon-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å"><i class="fa-solid fa-eye"></i></button>
              <span id="password-validation" class="validation" aria-hidden="true" title=""></span>
            </div>
          </div>

          <!-- strength bar (separate, won't overlap confirm) -->
          <div class="pw-wrap" aria-hidden="true">
            <div class="pw-track"><div id="pw-bar" class="pw-bar" role="presentation"></div></div>
          </div>

          <!-- confirm password -->
          <div class="field">
            <label for="confirm-password" class="sr-only">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <i class="fa-solid fa-lock left-icon" aria-hidden="true"></i>
            <input id="confirm-password" class="input" type="password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
            <div class="right-group">
              <!-- toggle for confirm password -->
              <button type="button" id="toggle-confirm" class="icon-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è"><i class="fa-solid fa-eye"></i></button>
              <span id="confirm-validation" class="validation" aria-hidden="true" title=""></span>
            </div>
          </div>

          <button id="register-btn" class="btn" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          <p class="muted">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <button id="show-login" type="button" class="link">–í–æ–π—Ç–∏</button></p>
        </form>

        <!-- Login form (hidden by default) -->
        <form id="login-form" novalidate aria-labelledby="login-title" hidden>
          <h2 id="login-title">–í—Ö–æ–¥</h2>
          <p class="subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</p>

          <div class="field">
            <label for="login-username" class="sr-only">–ù–∏–∫</label>
            <i class="fa-solid fa-user left-icon" aria-hidden="true"></i>
            <input id="login-username" class="input" placeholder="–í–∞—à –Ω–∏–∫" />
            <div class="right-group"><span id="login-username-validation" class="validation" aria-hidden="true" title=""></span></div>
          </div>

          <div class="field">
            <label for="login-password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
            <i class="fa-solid fa-lock left-icon" aria-hidden="true"></i>
            <input id="login-password" class="input" type="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" />
            <div class="right-group">
              <button type="button" id="toggle-login-password" class="icon-btn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å"><i class="fa-solid fa-eye"></i></button>
              <span id="login-password-validation" class="validation" aria-hidden="true" title=""></span>
            </div>
          </div>

          <button id="login-btn" class="btn" type="submit">–í–æ–π—Ç–∏</button>
          <p class="muted">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button id="show-register" type="button" class="link">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button></p>
        </form>
      </div>
    </div>
  </div>

  <!-- Chat Interface -->
  <div id="chat-interface">
    <div class="sidebar" id="sidebar">
      <div class="my-profile-mini" id="profile-button">
        <img id="user-avatar" src="https://ui-avatars.com/api/?background=random&color=fff&name=User" class="avatar">
        <div style="flex:1">
          <div style="font-weight: 700;" id="current-user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
          <div style="font-size: 12px; color: var(--text-muted);" id="user-status">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Stercord!</div>
        </div>
      </div>

      <div class="contact-list" id="contact-list">
        <div style="text-align:center; padding: 20px; color:var(--text-muted)">
          –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤<br>
          <small>–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π –¥–ª—è –æ–±—â–µ–Ω–∏—è</small>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <div>
          <h3 style="margin:0">Stercord</h3>
          <div style="font-size: 12px; color: var(--text-muted);">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª–µ–Ω–∏—è</div>
        </div>
        <button class="chat-btn" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> –í—ã–π—Ç–∏</button>
      </div>

      <div id="welcome-state" style="text-align:center; padding: 50px; color:var(--text-muted); flex:1; display:flex; flex-direction:column; justify-content:center;">
        <div style="font-size: 40px; margin-bottom: 10px;">üëã</div>
        <h3 style="margin:0">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Stercord</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
      </div>
      
      <div class="messages-container" id="messages-container" style="display: none;"></div>
      
      <div class="input-zone" id="input-zone" style="display: none;">
        <input type="text" class="chat-input" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button class="chat-btn" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="margin:0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
        <button class="modal-close" id="close-modal">&times;</button>
      </div>
      <img id="avatar-preview" src="https://ui-avatars.com/api/?background=random&color=fff&name=User" class="avatar-preview">
      <form id="profile-form">
        <div class="modal-field">
          <label class="modal-label" for="edit-avatar">URL –∞–≤–∞—Ç–∞—Ä–∫–∏</label>
          <input type="text" id="edit-avatar" class="modal-input" placeholder="https://example.com/avatar.jpg">
        </div>
        <div class="modal-field">
          <label class="modal-label" for="edit-nickname">–ù–∏–∫–Ω–µ–π–º</label>
          <input type="text" id="edit-nickname" class="modal-input" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        </div>
        <div class="modal-field">
          <label class="modal-label" for="edit-bio">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="edit-bio" class="modal-input modal-textarea" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ"></textarea>
        </div>
        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      </form>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDcdjEYGAw-3KNUgKcTv6gZoWimRHjLXJM",
      authDomain: "stercord-8a8a6.firebaseapp.com",
      projectId: "stercord-8a8a6",
      storageBucket: "stercord-8a8a6.firebasestorage.app",
      messagingSenderId: "343792546482",
      appId: "1:343792546482:web:bbf77237918247f2820fab",
      measurementId: "G-YZSBBRJHHS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const registerForm = document.getElementById('register-form');
    const loginForm = document.getElementById('login-form');
    const showLogin = document.getElementById('show-login');
    const showRegister = document.getElementById('show-register');
    const authContainer = document.getElementById('auth-container');
    const chatInterface = document.getElementById('chat-interface');
    const currentUserElement = document.getElementById('current-user');
    const userAvatar = document.getElementById('user-avatar');
    const userStatus = document.getElementById('user-status');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const inputZone = document.getElementById('input-zone');
    const welcomeState = document.getElementById('welcome-state');
    const logoutBtn = document.getElementById('logout-btn');
    const profileButton = document.getElementById('profile-button');
    const profileModal = document.getElementById('profile-modal');
    const closeModal = document.getElementById('close-modal');
    const profileForm = document.getElementById('profile-form');
    const avatarPreview = document.getElementById('avatar-preview');
    const editAvatar = document.getElementById('edit-avatar');
    const editNickname = document.getElementById('edit-nickname');
    const editBio = document.getElementById('edit-bio');

    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm-password');

    const usernameValidation = document.getElementById('username-validation');
    const passwordValidation = document.getElementById('password-validation');
    const confirmValidation = document.getElementById('confirm-validation');
    const pwBar = document.getElementById('pw-bar');

    const togglePassword = document.getElementById('toggle-password');
    const toggleConfirm = document.getElementById('toggle-confirm');

    const loginUsername = document.getElementById('login-username');
    const loginPassword = document.getElementById('login-password');
    const loginUsernameValidation = document.getElementById('login-username-validation');
    const loginPasswordValidation = document.getElementById('login-password-validation');
    const toggleLoginPassword = document.getElementById('toggle-login-password');

    const toast = document.getElementById('toast');

    // Current user data
    let currentUserData = null;

    // Utilities
    function showToast(text, time=2200){
      toast.textContent = text;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), time);
    }

    function setValid(el, title='OK'){
      el.classList.remove('invalid');
      el.classList.add('valid','show');
      el.innerHTML = '<i class="fa-solid fa-check"></i>';
      el.title = title;
    }
    
    function setInvalid(el, title='–û—à–∏–±–∫–∞'){
      el.classList.remove('valid');
      el.classList.add('invalid','show');
      el.innerHTML = '<i class="fa-solid fa-xmark"></i>';
      el.title = title;
      // micro-shake
      el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:320});
    }
    
    function clearVal(el){ el.classList.remove('valid','invalid','show'); el.innerHTML=''; el.title=''; }

    // Username validation (Unicode letters & numbers, underscore, hyphen)
    const usernameRe = /^[\p{L}\p{N}_-]{3,20}$/u;
    usernameInput.addEventListener('input', ()=>{
      const v = usernameInput.value.trim();
      if(!v){ clearVal(usernameValidation); return; }
      if(!usernameRe.test(v)) setInvalid(usernameValidation, '–ù–∏–∫: 3‚Äì20 —Å–∏–º–≤–æ–ª–æ–≤, –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/_/-');
      else setValid(usernameValidation,'–ù–∏–∫ –ø—Ä–∏–Ω—è—Ç');
    });

    // Password strength
    function scorePassword(pwd){
      let s=0;
      if(pwd.length>=6) s++;
      if(/[A-Z]/.test(pwd)) s++;
      if(/[0-9]/.test(pwd)) s++;
      if(/[^A-Za-z0-9]/.test(pwd)) s++;
      return s;
    }
    
    function updatePw(){
      const pwd = passwordInput.value;
      const s = scorePassword(pwd);
      pwBar.classList.remove('weak','medium','strong');
      if(!pwd){ pwBar.style.width='0%'; clearVal(passwordValidation); }
      else if(s<2){ pwBar.classList.add('weak'); pwBar.style.width='30%'; setInvalid(passwordValidation,'–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å'); }
      else if(s<4){ pwBar.classList.add('medium'); pwBar.style.width='66%'; setInvalid(passwordValidation,'–°—Ä–µ–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å'); }
      else { pwBar.classList.add('strong'); pwBar.style.width='100%'; setValid(passwordValidation,'–ù–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å'); }
      validateConfirm();
    }
    
    passwordInput.addEventListener('input', updatePw);

    // Confirm validation
    function validateConfirm(){
      const p = passwordInput.value;
      const c = confirmInput.value;
      if(!c){ clearVal(confirmValidation); return; }
      if(p === c && p.length>=6) setValid(confirmValidation,'–ü–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      else setInvalid(confirmValidation,'–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
    }
    
    confirmInput.addEventListener('input', validateConfirm);

    // Toggles (each input has its own toggle, placed before validation)
    function toggleInputVisibility(inputEl, buttonEl){
      const isPwd = inputEl.type === 'password';
      inputEl.type = isPwd ? 'text' : 'password';
      // swap icon
      buttonEl.innerHTML = isPwd ? '<i class="fa-solid fa-eye-slash"></i>' : '<i class="fa-solid fa-eye"></i>';
      buttonEl.setAttribute('aria-label', isPwd ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å');
    }
    
    togglePassword.addEventListener('click', ()=> toggleInputVisibility(passwordInput, togglePassword));
    toggleConfirm.addEventListener('click', ()=> toggleInputVisibility(confirmInput, toggleConfirm));
    toggleLoginPassword.addEventListener('click', ()=> toggleInputVisibility(loginPassword, toggleLoginPassword));

    // Register submit
    registerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      let ok = true;
      const user = usernameInput.value.trim();
      const pwd = passwordInput.value;
      const conf = confirmInput.value;

      if(!usernameRe.test(user)){ setInvalid(usernameValidation,'–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫'); ok=false; }
      if(scorePassword(pwd) < 4){ setInvalid(passwordValidation,'–ü–∞—Ä–æ–ª—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–¥—ë–∂–µ–Ω'); ok=false; }
      if(pwd !== conf || conf.length===0){ setInvalid(confirmValidation,'–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç'); ok=false; }

      if(!ok){
        registerForm.classList.remove('shake');
        void registerForm.offsetWidth;
        registerForm.classList.add('shake');
        showToast('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ');
        return;
      }

      try {
        // Create user in Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, user + '@stercord.com', pwd);
        const userUid = userCredential.user.uid;
        
        // Create user profile in Firestore
        await setDoc(doc(db, 'users', userUid), {
          username: user,
          avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(user)}&background=random&color=fff`,
          bio: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Stercord',
          createdAt: serverTimestamp()
        });
        
        showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!');
        
        // Clear form
        usernameInput.value=''; passwordInput.value=''; confirmInput.value='';
        clearVal(usernameValidation); clearVal(passwordValidation); clearVal(confirmValidation);
        pwBar.style.width='0%'; pwBar.classList.remove('weak','medium','strong');
        
        // Switch to login form
        switchForms(registerForm, loginForm);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
        showToast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
      }
    });

    // Login submit
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      let ok = true;
      const user = loginUsername.value.trim();
      
      if(!user){ setInvalid(loginUsernameValidation,'–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫'); ok=false; } else setValid(loginUsernameValidation,'OK');
      if(!loginPassword.value){ setInvalid(loginPasswordValidation,'–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'); ok=false; } else setValid(loginPasswordValidation,'OK');

      if(!ok){
        loginForm.classList.remove('shake');
        void loginForm.offsetWidth;
        loginForm.classList.add('shake');
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
        return;
      }
      
      try {
        // Sign in with Firebase Auth
        await signInWithEmailAndPassword(auth, user + '@stercord.com', loginPassword.value);
        showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
      }
    });

    // Firebase Auth State Observer
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in
        try {
          // Get user data from Firestore
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          
          if (userDoc.exists()) {
            currentUserData = userDoc.data();
            currentUserData.uid = user.uid;
            
            // Update UI with user data
            currentUserElement.textContent = currentUserData.username;
            userAvatar.src = currentUserData.avatar;
            userStatus.textContent = currentUserData.bio || '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Stercord!';
            
            // Show chat interface
            authContainer.style.display = 'none';
            chatInterface.style.display = 'flex';
            
            // Load messages if in a chat
            // For now, just show welcome state
            welcomeState.style.display = 'flex';
            messagesContainer.style.display = 'none';
            inputZone.style.display = 'none';
          } else {
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            await signOut(auth);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
        }
      } else {
        // User is signed out
        currentUserData = null;
        authContainer.style.display = 'flex';
        chatInterface.style.display = 'none';
        
        // Clear forms
        loginUsername.value = '';
        loginPassword.value = '';
        clearVal(loginUsernameValidation);
        clearVal(loginPasswordValidation);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
      }
    });

    // Profile editing
    profileButton.addEventListener('click', () => {
      if (currentUserData) {
        // Fill modal with current data
        editAvatar.value = currentUserData.avatar || '';
        editNickname.value = currentUserData.username || '';
        editBio.value = currentUserData.bio || '';
        avatarPreview.src = currentUserData.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserData.username)}&background=random&color=fff`;
        
        // Show modal
        profileModal.style.display = 'flex';
      }
    });

    // Close modal
    closeModal.addEventListener('click', () => {
      profileModal.style.display = 'none';
    });

    // Update avatar preview when URL changes
    editAvatar.addEventListener('input', () => {
      if (editAvatar.value) {
        avatarPreview.src = editAvatar.value;
      } else {
        avatarPreview.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(editNickname.value || 'User')}&background=random&color=fff`;
      }
    });

    // Save profile changes
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUserData) return;
      
      try {
        const updates = {
          username: editNickname.value,
          avatar: editAvatar.value || `https://ui-avatars.com/api/?name=${encodeURIComponent(editNickname.value)}&background=random&color=fff`,
          bio: editBio.value,
          updatedAt: serverTimestamp()
        };
        
        // Update in Firestore
        await updateDoc(doc(db, 'users', currentUserData.uid), updates);
        
        // Update local data and UI
        currentUserData = { ...currentUserData, ...updates };
        currentUserElement.textContent = currentUserData.username;
        userAvatar.src = currentUserData.avatar;
        userStatus.textContent = currentUserData.bio;
        
        // Close modal
        profileModal.style.display = 'none';
        
        showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
        showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message);
      }
    });

    // Switch forms
    function switchForms(hide, show){
      hide.hidden = true;
      show.hidden = false;
      const f = show.querySelector('input');
      if(f) f.focus();
    }
    
    showLogin.addEventListener('click', ()=> switchForms(registerForm, loginForm));
    showRegister.addEventListener('click', ()=> switchForms(loginForm, registerForm));
  </script>
</body>
</html>
